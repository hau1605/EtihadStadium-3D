<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport"
	content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Smartcity - Building Map</title>

<style>
	* {
		padding: 0;
		margin: 0;
	}
	html, body, #viewDiv {
		height: 100%;
		width: 100%;
	}
</style>

<link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.28/"></script>
<script>
	var list_points = [];
    var string_points = "";
	function copyTextToClipboard(text) {
        if (!navigator.clipboard) {
            fallbackCopyTextToClipboard(text);
            return;
        }
        navigator.clipboard.writeText(text).then(function() {
            console.log('Async: Copying to clipboard was successful!');
        }, function(err) {
            console.error('Async: Could not copy text: ', err);
        });
    }
        require([
            "esri/Map",
			"esri/Graphic",
            "esri/views/SceneView",
			"esri/geometry/Mesh",
			"esri/geometry/Point",
            "esri/layers/GeoJSONLayer",
            "esri/layers/SceneLayer", "esri/layers/GraphicsLayer", "esri/Graphic", "esri/request"
        ], function (Map, Graphic, SceneView, Mesh, Point, GeoJSONLayer, SceneLayer,
                     GraphicsLayer, Graphic, esriRequest) {
        	var createGraphic = function(data) {
    			return new Graphic({
    				geometry : data,
    				symbol : data.symbol,
    				attributes : data,
    				popupTemplate : data.popupTemplate
    			});
    		};
    		
    		const json_options = {
    			query : {
    				f : "json"
    			},
    			responseType : "json"
    		};
			// request json
			esriRequest('./data/data.json', json_options).then(function(response) {
				var graphicsLayer = new GraphicsLayer();
				console.log(response);
				response.data.forEach(function(data){
					graphicsLayer.add(createGraphic(data));
				});
				map.add(graphicsLayer);

			});
			// geojson layer
			const geojsonLayer = new GeoJSONLayer({
				url: "./data/data.geojson"
			});
			// Zone A
			const geojsonLayer_A_roof = new GeoJSONLayer({
				url: "./data/zone_a/zone_a_roof.geojson"
			});
			const geojsonLayer_A_wall = new GeoJSONLayer({
				url: "./data/zone_a/zone_a_wall.geojson"
			});
			// Zone B
			const geojsonLayer_B_roof = new GeoJSONLayer({
				url: "./data/zone_b/zone_b_roof.geojson"
			});
			const geojsonLayer_B_wall = new GeoJSONLayer({
				url: "./data/zone_b/zone_b_wall.geojson"
			});
			// Zone C
			const geojsonLayer_C_roof = new GeoJSONLayer({
				url: "./data/zone_c/zone_c_roof.geojson"
			});
			const geojsonLayer_C_wall = new GeoJSONLayer({
				url: "./data/zone_c/zone_c_wall.geojson"
			});
			// Zone D
			const geojsonLayer_D_roof = new GeoJSONLayer({
				url: "./data/zone_d/zone_d_roof.geojson"
			});
			const geojsonLayer_D_wall = new GeoJSONLayer({
				url: "./data/zone_d/zone_d_wall.geojson"
			});
			// Zone E
			const geojsonLayer_E_roof = new GeoJSONLayer({
				url: "./data/zone_e/zone_e_roof.geojson"
			});
			const geojsonLayer_E_wall = new GeoJSONLayer({
				url: "./data/zone_e/zone_e_wall.geojson"
			});
			
			geojsonLayer_A_roof.renderer = {
				type: "simple",
				symbol: {
					type: "polygon-3d",
					symbolLayers: [
						{
							type: "extrude",
							size: 100.00000,
							material: {
								color: "blue"
							}
						}
					]
				}
			}; 

			geojsonLayer.renderer = {
				type: "simple",
				symbol: {
					type: "polygon-3d",
					symbolLayers: [
						{
							type: "extrude",
							size: 100.00000,
							material: {
								color: "green"
							}
						}
					]
				}
			};     

			const map = new Map({
                basemap: "topo-vector",
                ground: "world-elevation",
                layers: [
					geojsonLayer, 
					geojsonLayer_A_roof,
					geojsonLayer_A_wall,
					geojsonLayer_B_roof,
					geojsonLayer_B_wall,
					geojsonLayer_C_roof,
					geojsonLayer_C_wall,
					geojsonLayer_D_roof,
					geojsonLayer_D_wall,
					geojsonLayer_E_roof,
					geojsonLayer_E_wall
				]
            });

            const view = new SceneView({
                container: "viewDiv",
                map: map,
                camera: {
                    position: [-2.1957615021032595, 53.4836002000014, 300],
                    heading: 260,
                    tilt: 50
                }
            });
            view.popup.defaultPopupTemplateEnabled = true;
			// view.popup.autoOpenEnabled = false;
            view.on("click", function(event) { // Listen for the click event
                view.hitTest(event).then(function(hitTestResults) {
                    if (hitTestResults.results) {        
                        list_points.push([event.mapPoint.longitude, event.mapPoint.latitude]);
                        string_points += "[" + event.mapPoint.longitude + ", " + event.mapPoint.latitude + "],"
                        copyTextToClipboard(string_points);
                    }
                })
            });
            /* ============================================================ */
            
            /* ============================================================ */
			const location_1 = new Point({
                x: -2.2039190504606783,
                y: 53.48385645170768,
                z: 50
            });
			Mesh.createFromGLTF(location_1, "./model/X7Blender.glb") 
                .then(function (geometry) {
                    geometry.scale(10, { origin: location_1 });
                    geometry.rotate(0, 0, 0);
                    const graphic = new Graphic({
                        geometry,
                        symbol: {
							type: "mesh-3d",
                            symbolLayers: [
							{
								type: "fill",
                                material: {
									color: "gray"
								},
                                size: 1000
                            }]
                        }
                    });
					view.graphics.add(graphic);
				})
                .catch(console.error);
			});
            /* ============================================================ */

            
            /* ============================================================ */
            
            /* ============================================================ */
    </script>
</head>

<body>
	<div id="viewDiv"></div>
</body>
</html>